import json
import logging
import re
import asyncio
from flask import Flask, request
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„Ù‘Ø§Øª
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("quran-bot")

# ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù‚Ø±Ø¢Ù† (Ù„Ø§Ø­Ø¸ JSON Ø§Ù„ÙƒØ¨ÙŠØ±)
try:
    with open("surah_data.JSON", "r", encoding="utf-8") as f:
        quran_data = json.load(f)
    logger.info("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ surah_data.JSON Ø¨Ù†Ø¬Ø§Ø­.")
except Exception as e:
    logger.error(f"âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù surah_data.JSON: {e}")
    quran_data = []

# ØªÙ‡ÙŠØ¦Ø© Flask
app = Flask(__name__)

# Ø¶Ø¹ Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¨ÙˆØª Ù‡Ù†Ø§ Ø£Ùˆ ÙƒÙ…ØªØºÙŠØ± Ø¨ÙŠØ¦Ø© ÙÙŠ Render
TOKEN = "Ø¶Ø¹_Ø§Ù„ØªÙˆÙƒÙ†_Ù‡Ù†Ø§"

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¨ÙˆØª
application = Application.builder().token(TOKEN).build()

# ğŸ”¹ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    message = (
        "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ *Ø¨ÙˆØª Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…*.\n\n"
        "ğŸ“– Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØªØŒ Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø© Ù…ØªØ¨ÙˆØ¹Ù‹Ø§ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ©.\n"
        "Ù…Ø«Ù„Ø§Ù‹:\n"
        "`Ø§Ù„Ø¨Ù‚Ø±Ø© 2`\n"
        "`Ù‚Ø±ÙŠØ´ 3`\n\n"
        "âœ… Ù…Ù„Ø§Ø­Ø¸Ø§Øª:\n"
        "- Ù„Ø§ ÙŠØ´ØªØ±Ø· ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø£Ù„Ù ÙˆØ§Ù„Ù„Ø§Ù… Ø£Ùˆ Ø§Ù„ØªØ§Ø¡ Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø© Ø¨Ø¯Ù‚Ø©.\n"
        "- ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© (Ø¨Ù‚Ø±Ù‡ 2) Ø£Ùˆ (Ø§Ù„Ù‚Ø±Ø© 2) ÙˆØ³ØªØ¸Ù‡Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©."
    )
    await update.message.reply_text(message, parse_mode="Markdown")

# ğŸ”¹ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
def find_ayah(surah_name, ayah_number):
    surah_name_normalized = re.sub(r"[Ø§Ø£Ø¥Ø¢]", "Ø§", surah_name.strip().lower())

    for surah in quran_data:
        name_normalized = re.sub(r"[Ø§Ø£Ø¥Ø¢]", "Ø§", surah["name"].strip().lower())
        if surah_name_normalized in name_normalized or name_normalized in surah_name_normalized:
            for verse in surah["verses"]:
                if str(verse["id"]) == str(ayah_number):
                    return f"ğŸ“– *{surah['name']} - Ø¢ÙŠØ© {verse['id']}*\n\n{verse['text']}"
    return "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙˆØ±Ø© Ø£Ùˆ Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©."

# ğŸ”¹ Ø¹Ù†Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.strip()
    match = re.match(r"([\u0600-\u06FF\s]+)\s+(\d+)", text)
    if match:
        surah_name = match.group(1)
        ayah_number = match.group(2)
        result = find_ayah(surah_name, ayah_number)
        await update.message.reply_text(result, parse_mode="Markdown")
    else:
        await update.message.reply_text("â—ï¸Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø© Ù…ØªØ¨ÙˆØ¹Ù‹Ø§ Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ©ØŒ Ù…Ø«Ù„:\nØ§Ù„Ø¨Ù‚Ø±Ø© 2")

# ğŸ”¹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
application.add_handler(CommandHandler("start", start))
application.add_handler(CommandHandler("help", start))
application.add_handler(CommandHandler("about", start))
application.add_handler(CommandHandler("info", start))
application.add_handler(CommandHandler("quran", start))
application.add_handler(CommandHandler("ayah", start))
application.add_handler(CommandHandler("verse", start))
application.add_handler(CommandHandler("a", start))
application.add_handler(CommandHandler("b", start))
application.add_handler(CommandHandler("s", start))
application.add_handler(CommandHandler("h", start))
application.add_handler(CommandHandler("x", start))
application.add_handler(CommandHandler("m", start))
application.add_handler(CommandHandler("n", start))
application.add_handler(CommandHandler("q", start))
application.add_handler(CommandHandler("k", start))
application.add_handler(CommandHandler("o", start))
application.add_handler(CommandHandler("c", start))
application.add_handler(CommandHandler("y", start))
application.add_handler(CommandHandler("r", start))
application.add_handler(CommandHandler("v", start))
application.add_handler(CommandHandler("g", start))
application.add_handler(CommandHandler("l", start))
application.add_handler(CommandHandler("z", start))
application.add_handler(CommandHandler("p", start))
application.add_handler(CommandHandler("w", start))
application.add_handler(CommandHandler("e", start))
application.add_handler(CommandHandler("t", start))
application.add_handler(CommandHandler("d", start))
application.add_handler(CommandHandler("f", start))
application.add_handler(CommandHandler("u", start))
application.add_handler(CommandHandler("j", start))
application.add_handler(CommandHandler("i", start))
application.add_handler(CommandHandler("s", start))
application.add_handler(CommandHandler("b", start))
application.add_handler(CommandHandler("a", start))
application.add_handler(CommandHandler("n", start))
application.add_handler(CommandHandler("x", start))
application.add_handler(CommandHandler("k", start))
application.add_handler(CommandHandler("y", start))
application.add_handler(CommandHandler("r", start))
application.add_handler(CommandHandler("t", start))
application.add_handler(CommandHandler("c", start))
application.add_handler(CommandHandler("l", start))
application.add_handler(CommandHandler("v", start))
application.add_handler(CommandHandler("m", start))
application.add_handler(CommandHandler("z", start))
application.add_handler(CommandHandler("q", start))
application.add_handler(CommandHandler("p", start))
application.add_handler(CommandHandler("o", start))
application.add_handler(CommandHandler("w", start))
application.add_handler(CommandHandler("f", start))
application.add_handler(CommandHandler("e", start))
application.add_handler(CommandHandler("d", start))
application.add_handler(CommandHandler("g", start))
application.add_handler(CommandHandler("u", start))
application.add_handler(CommandHandler("h", start))
application.add_handler(CommandHandler("j", start))
application.add_handler(CommandHandler("i", start))
application.add_handler(CommandHandler("n", start))
application.add_handler(CommandHandler("s", start))
application.add_handler(CommandHandler("a", start))
application.add_handler(CommandHandler("b", start))
application.add_handler(CommandHandler("m", start))
application.add_handler(CommandHandler("x", start))
application.add_handler(CommandHandler("l", start))
application.add_handler(CommandHandler("q", start))
application.add_handler(CommandHandler("v", start))
application.add_handler(CommandHandler("r", start))
application.add_handler(CommandHandler("t", start))
application.add_handler(CommandHandler("y", start))
application.add_handler(CommandHandler("e", start))
application.add_handler(CommandHandler("f", start))
application.add_handler(CommandHandler("h", start))
application.add_handler(CommandHandler("j", start))
application.add_handler(CommandHandler("i", start))
application.add_handler(CommandHandler("u", start))
application.add_handler(CommandHandler("o", start))
application.add_handler(CommandHandler("p", start))
application.add_handler(CommandHandler("g", start))
application.add_handler(CommandHandler("w", start))
application.add_handler(CommandHandler("z", start))
application.add_handler(CommandHandler("c", start))
application.add_handler(CommandHandler("d", start))
application.add_handler(CommandHandler("n", start))
application.add_handler(CommandHandler("q", start))
application.add_handler(CommandHandler("x", start))
application.add_handler(CommandHandler("y", start))
application.add_handler(CommandHandler("b", start))
application.add_handler(CommandHandler("k", start))
application.add_handler(CommandHandler("l", start))
application.add_handler(CommandHandler("v", start))
application.add_handler(CommandHandler("r", start))
application.add_handler(CommandHandler("m", start))
application.add_handler(CommandHandler("n", start))
application.add_handler(CommandHandler("t", start))
application.add_handler(CommandHandler("e", start))
application.add_handler(CommandHandler("f", start))
application.add_handler(CommandHandler("g", start))
application.add_handler(CommandHandler("h", start))
application.add_handler(CommandHandler("j", start))
application.add_handler(CommandHandler("i", start))
application.add_handler(CommandHandler("u", start))
application.add_handler(CommandHandler("o", start))
application.add_handler(CommandHandler("p", start))
application.add_handler(CommandHandler("w", start))
application.add_handler(CommandHandler("z", start))
application.add_handler(CommandHandler("c", start))
application.add_handler(CommandHandler("d", start))
application.add_handler(CommandHandler("a", start))
application.add_handler(CommandHandler("b", start))
application.add_handler(CommandHandler("s", start))
application.add_handler(CommandHandler("m", start))
application.add_handler(CommandHandler("x", start))
application.add_handler(CommandHandler("l", start))
application.add_handler(CommandHandler("q", start))
application.add_handler(CommandHandler("v", start))
application.add_handler(CommandHandler("r", start))
application.add_handler(CommandHandler("t", start))
application.add_handler(CommandHandler("y", start))
application.add_handler(CommandHandler("e", start))
application.add_handler(CommandHandler("f", start))
application.add_handler(CommandHandler("h", start))
application.add_handler(CommandHandler("j", start))
application.add_handler(CommandHandler("i", start))
application.add_handler(CommandHandler("u", start))
application.add_handler(CommandHandler("o", start))
application.add_handler(CommandHandler("p", start))
application.add_handler(CommandHandler("g", start))
application.add_handler(CommandHandler("w", start))
application.add_handler(CommandHandler("z", start))
application.add_handler(CommandHandler("c", start))
application.add_handler(CommandHandler("d", start))
application.add_handler(CommandHandler("n", start))
application.add_handler(CommandHandler("q", start))
application.add_handler(CommandHandler("x", start))
application.add_handler(CommandHandler("y", start))
application.add_handler(CommandHandler("b", start))
application.add_handler(CommandHandler("k", start))
application.add_handler(CommandHandler("l", start))
application.add_handler(CommandHandler("v", start))
application.add_handler(CommandHandler("r", start))
application.add_handler(CommandHandler("m", start))
application.add_handler(CommandHandler("n", start))
application.add_handler(CommandHandler("t", start))
application.add_handler(CommandHandler("e", start))
application.add_handler(CommandHandler("f", start))
application.add_handler(CommandHandler("g", start))
application.add_handler(CommandHandler("h", start))
application.add_handler(CommandHandler("j", start))
application.add_handler(CommandHandler("i", start))
application.add_handler(CommandHandler("u", start))
application.add_handler(CommandHandler("o", start))
application.add_handler(CommandHandler("p", start))
application.add_handler(CommandHandler("w", start))
application.add_handler(CommandHandler("z", start))
application.add_handler(CommandHandler("c", start))
application.add_handler(CommandHandler("d", start))
application.add_handler(CommandHandler("a", start))
application.add_handler(CommandHandler("b", start))
application.add_handler(CommandHandler("s", start))
application.add_handler(CommandHandler("m", start))
application.add_handler(CommandHandler("x", start))
application.add_handler(CommandHandler("l", start))
application.add_handler(CommandHandler("q", start))
application.add_handler(CommandHandler("v", start))
application.add_handler(CommandHandler("r", start))
application.add_handler(CommandHandler("t", start))
application.add_handler(CommandHandler("y", start))
application.add_handler(CommandHandler("e", start))
application.add_handler(CommandHandler("f", start))
application.add_handler(CommandHandler("h", start))
application.add_handler(CommandHandler("j", start))
application.add_handler(CommandHandler("i", start))
application.add_handler(CommandHandler("u", start))
application.add_handler(CommandHandler("o", start))
application.add_handler(CommandHandler("p", start))
application.add_handler(CommandHandler("g", start))
application.add_handler(CommandHandler("w", start))
application.add_handler(CommandHandler("z", start))
application.add_handler(CommandHandler("c", start))
application.add_handler(CommandHandler("d", start))
application.add_handler(CommandHandler("n", start))
application.add_handler(CommandHandler("q", start))
application.add_handler(CommandHandler("x", start))
application.add_handler(CommandHandler("y", start))
application.add_handler(CommandHandler("b", start))
application.add_handler(CommandHandler("k", start))
application.add_handler(CommandHandler("l", start))
application.add_handler(CommandHandler("v", start))
application.add_handler(CommandHandler("r", start))
application.add_handler(CommandHandler("m", start))
application.add_handler(CommandHandler("n", start))
application.add_handler(CommandHandler("t", start))
application.add_handler(CommandHandler("e", start))
application.add_handler(CommandHandler("f", start))
application.add_handler(CommandHandler("g", start))
application.add_handler(CommandHandler("h", start))
application.add_handler(CommandHandler("j", start))
application.add_handler(CommandHandler("i", start))
application.add_handler(CommandHandler("u", start))
application.add_handler(CommandHandler("o", start))
application.add_handler(CommandHandler("p", start))
application.add_handler(CommandHandler("w", start))
application.add_handler(CommandHandler("z", start))
application.add_handler(CommandHandler("c", start))
application.add_handler(CommandHandler("d", start))
application.add_handler(CommandHandler("a", start))
application.add_handler(CommandHandler("b", start))
application.add_handler(CommandHandler("s", start))
application.add_handler(CommandHandler("m", start))
application.add_handler(CommandHandler("x", start))
application.add_handler(CommandHandler("l", start))
application.add_handler(CommandHandler("q", start))
application.add_handler(CommandHandler("v", start))
application.add_handler(CommandHandler("r", start))
application.add_handler(CommandHandler("t", start))
application.add_handler(CommandHandler("y", start))
application.add_handler(CommandHandler("e", start))
application.add_handler(CommandHandler("f", start))
application.add_handler(CommandHandler("h", start))
application.add_handler(CommandHandler("j", start))
application.add_handler(CommandHandler("i", start))
application.add_handler(CommandHandler("u", start))
application.add_handler(CommandHandler("o", start))
application.add_handler(CommandHandler("p", start))
application.add_handler(CommandHandler("g", start))
application.add_handler(CommandHandler("w", start))
application.add_handler(CommandHandler("z", start))
application.add_handler(CommandHandler("c", start))
application.add_handler(CommandHandler("d", start))
application.add_handler(CommandHandler("n", start))
application.add_handler(CommandHandler("q", start))
application.add_handler(CommandHandler("x", start))
application.add_handler(CommandHandler("y", start))
application.add_handler(CommandHandler("b", start))
application.add_handler(CommandHandler("k", start))
application.add_handler(CommandHandler("l", start))
application.add_handler(CommandHandler("v", start))
application.add_handler(CommandHandler("r", start))
application.add_handler(CommandHandler("m", start))
application.add_handler(CommandHandler("n", start))
application.add_handler(CommandHandler("t", start))
application.add_handler(CommandHandler("e", start))
application.add_handler(CommandHandler("f", start))
application.add_handler(CommandHandler("g", start))
application.add_handler(CommandHandler("h", start))
application.add_handler(CommandHandler("j", start))
application.add_handler(CommandHandler("i", start))
application.add_handler(CommandHandler("u", start))
application.add_handler(CommandHandler("o", start))
application.add_handler(CommandHandler("p", start))
application.add_handler(CommandHandler("w", start))
application.add_handler(CommandHandler("z", start))
application.add_handler(CommandHandler("c", start))
application.add_handler(CommandHandler("d", start))

application.add_handler(CommandHandler("start", start))

# ØªØ´ØºÙŠÙ„ Webhook
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = Update.de_json(request.get_json(force=True), application.bot)
    asyncio.get_event_loop().create_task(application.process_update(update))
    return "OK", 200

@app.route("/")
def home():
    return "Quran Bot is running ğŸŒ™"

if __name__ == "__main__":
    loop = asyncio.get_event_loop()
    loop.create_task(application.initialize())
    app.run(host="0.0.0.0", port=10000)
