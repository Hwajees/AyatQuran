import os
import requests
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, MessageHandler, filters, ContextTypes
from flask import Flask
import threading
import asyncio

# ==============================
# ๐น ุฅุนุฏุงุฏ ุงูุชููู
# ==============================
BOT_TOKEN = os.getenv("BOT_TOKEN")

# ==============================
# ๐น ูุงุฆูุฉ ุจุฃุณูุงุก ุงูุณูุฑ ูุน ุฃุฑูุงููุง (ูุฃู API ูุณุชุฎุฏู ุฑูู ุงูุณูุฑุฉ)
# ==============================
sura_numbers = {
    "ุงููุงุชุญุฉ": 1, "ุงูุจูุฑุฉ": 2, "ุขู ุนูุฑุงู": 3, "ุงููุณุงุก": 4, "ุงููุงุฆุฏุฉ": 5,
    "ุงูุฃูุนุงู": 6, "ุงูุฃุนุฑุงู": 7, "ุงูุฃููุงู": 8, "ุงูุชูุจุฉ": 9, "ูููุณ": 10,
    "ููุฏ": 11, "ููุณู": 12, "ุงูุฑุนุฏ": 13, "ุฅุจุฑุงููู": 14, "ุงูุญุฌุฑ": 15,
    "ุงููุญู": 16, "ุงูุฅุณุฑุงุก": 17, "ุงูููู": 18, "ูุฑูู": 19, "ุทู": 20,
    "ุงูุฃูุจูุงุก": 21, "ุงูุญุฌ": 22, "ุงููุคูููู": 23, "ุงูููุฑ": 24, "ุงููุฑูุงู": 25,
    "ุงูุดุนุฑุงุก": 26, "ุงูููู": 27, "ุงููุตุต": 28, "ุงูุนููุจูุช": 29, "ุงูุฑูู": 30,
    "ูููุงู": 31, "ุงูุณุฌุฏุฉ": 32, "ุงูุฃุญุฒุงุจ": 33, "ุณุจุฃ": 34, "ูุงุทุฑ": 35,
    "ูุณ": 36, "ุงูุตุงูุงุช": 37, "ุต": 38, "ุงูุฒูุฑ": 39, "ุบุงูุฑ": 40,
    "ูุตูุช": 41, "ุงูุดูุฑู": 42, "ุงูุฒุฎุฑู": 43, "ุงูุฏุฎุงู": 44, "ุงูุฌุงุซูุฉ": 45,
    "ุงูุฃุญูุงู": 46, "ูุญูุฏ": 47, "ุงููุชุญ": 48, "ุงูุญุฌุฑุงุช": 49, "ู": 50,
    "ุงูุฐุงุฑูุงุช": 51, "ุงูุทูุฑ": 52, "ุงููุฌู": 53, "ุงูููุฑ": 54, "ุงูุฑุญูู": 55,
    "ุงููุงูุนุฉ": 56, "ุงูุญุฏูุฏ": 57, "ุงููุฌุงุฏูุฉ": 58, "ุงูุญุดุฑ": 59, "ุงูููุชุญูุฉ": 60,
    "ุงูุตู": 61, "ุงูุฌูุนุฉ": 62, "ุงูููุงูููู": 63, "ุงูุชุบุงุจู": 64, "ุงูุทูุงู": 65,
    "ุงูุชุญุฑูู": 66, "ุงูููู": 67, "ุงูููู": 68, "ุงูุญุงูุฉ": 69, "ุงููุนุงุฑุฌ": 70,
    "ููุญ": 71, "ุงูุฌู": 72, "ุงููุฒูู": 73, "ุงููุฏุซุฑ": 74, "ุงูููุงูุฉ": 75,
    "ุงูุฅูุณุงู": 76, "ุงููุฑุณูุงุช": 77, "ุงููุจุฃ": 78, "ุงููุงุฒุนุงุช": 79, "ุนุจุณ": 80,
    "ุงูุชูููุฑ": 81, "ุงูุงููุทุงุฑ": 82, "ุงููุทูููู": 83, "ุงูุงูุดูุงู": 84, "ุงูุจุฑูุฌ": 85,
    "ุงูุทุงุฑู": 86, "ุงูุฃุนูู": 87, "ุงูุบุงุดูุฉ": 88, "ุงููุฌุฑ": 89, "ุงูุจูุฏ": 90,
    "ุงูุดูุณ": 91, "ุงูููู": 92, "ุงูุถุญู": 93, "ุงูุดุฑุญ": 94, "ุงูุชูู": 95,
    "ุงูุนูู": 96, "ุงููุฏุฑ": 97, "ุงูุจููุฉ": 98, "ุงูุฒูุฒูุฉ": 99, "ุงูุนุงุฏูุงุช": 100,
    "ุงููุงุฑุนุฉ": 101, "ุงูุชูุงุซุฑ": 102, "ุงูุนุตุฑ": 103, "ุงูููุฒุฉ": 104, "ุงูููู": 105,
    "ูุฑูุด": 106, "ุงููุงุนูู": 107, "ุงูููุซุฑ": 108, "ุงููุงูุฑูู": 109, "ุงููุตุฑ": 110,
    "ุงููุณุฏ": 111, "ุงูุฅุฎูุงุต": 112, "ุงูููู": 113, "ุงููุงุณ": 114
}

# ==============================
# ๐น ุฏุงูุฉ ุจุฏุก ุงูุจูุช
# ==============================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "๐ ุฃููุงู ุจู ูู ุจูุช ุงููุฑุขู ุงููุฑูู!\n\n"
        "ุงูุชุจ ุงุณู ุงูุณูุฑุฉ ูุฑูู ุงูุขูุฉ ูุซู:\n"
        "ุงูุจูุฑุฉ 255\n\n"
        "ูุณุฃุฑุณู ูู ุงูุขูุฉ ุงููุทููุจุฉ ุจุฅุฐู ุงููู ๐"
    )

# ==============================
# ๐น ุฏุงูุฉ ุฌูุจ ุงูุขูุฉ
# ==============================
async def get_ayah(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_input = update.message.text.strip()
    parts = user_input.split()

    if len(parts) != 2:
        await update.message.reply_text("โ๏ธ ุฃุฑุณู ุงุณู ุงูุณูุฑุฉ ูุชุจูุนูุง ุจุฑูู ุงูุขูุฉุ ูุซู: ุงูููู 10")
        return

    sura_name, ayah_number = parts

    if sura_name not in sura_numbers:
        await update.message.reply_text("โ ูู ุฃุฌุฏ ูุฐู ุงูุณูุฑุฉ. ุชุฃูุฏ ูู ูุชุงุจุฉ ุงูุงุณู ุจุงูุนุฑุจูุฉ ูุซู: ุงูุจูุฑุฉ ุฃู ุงูููู.")
        return

    if not ayah_number.isdigit():
        await update.message.reply_text("โ๏ธ ุฑูู ุงูุขูุฉ ูุฌุจ ุฃู ูููู ุฑูููุงุ ูุซู: ุงูุจูุฑุฉ 255")
        return

    sura_number = sura_numbers[sura_name]
    ayah_number = int(ayah_number)

    # ุทูุจ ุงูุขูุฉ ูู API
    url = f"https://api.alquran.cloud/v1/ayah/{sura_number}:{ayah_number}"
    response = requests.get(url)
    data = response.json()

    if data["code"] == 200:
        verse_text = data["data"]["text"]
        await update.message.reply_text(f"๐ {sura_name} ({ayah_number})\n\n{verse_text}")
    else:
        await update.message.reply_text("โ ูู ุฃุฌุฏ ูุฐู ุงูุขูุฉ. ุชุฃูุฏ ูู ุฑูููุง ุงูุตุญูุญ.")

# ==============================
# ๐น Flask ูุชุดุบูู ุงูุฎุฏูุฉ ุนูู Render Web Service
# ==============================
app = Flask(__name__)

@app.route('/')
def home():
    return "โ Quran Bot is running on Render!"

def run_flask():
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))

# ==============================
# ๐น ุชุดุบูู ุงูุจูุช
# ==============================
async def main():
    app_bot = ApplicationBuilder().token(BOT_TOKEN).build()
    app_bot.add_handler(CommandHandler("start", start))
    app_bot.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, get_ayah))
    print("โ ุงูุจูุช ูุนูู ุงูุขู ุนูู Render...")
    await app_bot.run_polling()

if __name__ == "__main__":
    threading.Thread(target=run_flask).start()
    asyncio.run(main())